on: [push, create, pull_request]
jobs:
  build-windows-msvc:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build Reindexer
        run: |
          mkdir build && cd build
          cmake -G "Visual Studio 16 2019" ..
          cmake --build . --config Release
          cmake --build . --config Release --target face
          cmake --build . --config Release --target swagger
          cpack
        shell: bash

  build-windows-mingw:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build Reindexer
        run: |
          mkdir build && cd build
          cmake -G "MinGW Makefiles" ..
          cmake --build . --config Release
          cmake --build . --config Release --target face
          cmake --build . --config Release --target swagger
        shell: bash

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - name: Prepare Environment
        run: |
          brew install googletest
          ./.github/workflows/install_gbench.sh
          ./dependencies.sh
          #brew install protobuf
          #./.github/workflows/install_grpc.sh
        shell: bash
      - name: Build Reindexer
        run: |
          #find / -name libgtest*
          #export CPLUS_INCLUDE_PATH=$GITHUB_WORKSPACE/grpc/third_party/abseil-cpp
          mkdir build && cd build
          #cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_GRPC=ON -DGRPC_PACKAGE_PROVIDER="MODULE" ..
          cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo ..
          make -j4
          STRIP=/bin/true cpack
        shell: bash
      - name: CXX Tests
        run: |
          cd build
          ctest --verbose
        shell: bash

  build-ubuntu20:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - name: Prepare Environment
        run: |
          sudo apt-get install libgtest-dev
          ./.github/workflows/install_gbench.sh
          sudo ./dependencies.sh
          #sudo apt-get install libprotobuf-dev
          #./.github/workflows/install_grpc.sh
        shell: bash
      - name: Build Reindexer
        run: |
          #find / -name libgtest*
          #export CPLUS_INCLUDE_PATH=$GITHUB_WORKSPACE/grpc/third_party/abseil-cpp
          mkdir build && cd build
          #cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_GRPC=ON -DGRPC_PACKAGE_PROVIDER="MODULE" ..
          cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo ..
          make -j4
          STRIP=/bin/true cpack
        shell: bash
      - name: CXX Tests
        run: |
          cd build
          ctest --verbose
        shell: bash

  build-ubuntu18:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Prepare Environment
        run: |
          sudo apt-get install libgtest-dev
          ./.github/workflows/install_gbench.sh
          sudo ./dependencies.sh
          #sudo apt-get install libprotobuf-dev
          #./.github/workflows/install_grpc.sh
        shell: bash
      - name: Build Reindexer
        run: |
          find / -name libgtest*
          #export CPLUS_INCLUDE_PATH=$GITHUB_WORKSPACE/grpc/third_party/abseil-cpp
          mkdir build && cd build
          #cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_GRPC=ON -DGRPC_PACKAGE_PROVIDER="MODULE" ..
          cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo ..
          make -j4
          STRIP=/bin/true cpack
        shell: bash
      - name: CXX Tests
        run: |
          cd build
          ctest --verbose
        shell: bash

  build-asan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Prepare Environment
        run: |
          sudo apt-get install libgtest-dev
          ./.github/workflows/install_gbench.sh
          sudo ./dependencies.sh
          #sudo apt-get install libprotobuf-dev
          #./.github/workflows/install_grpc.sh
        shell: bash
      - name: Build Reindexer
        run: |
          #export CPLUS_INCLUDE_PATH=$GITHUB_WORKSPACE/grpc/third_party/abseil-cpp
          mkdir build && cd build
          #cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo -DWITH_ASAN=On -DENABLE_GRPC=ON -DGRPC_PACKAGE_PROVIDER="MODULE" ..
          cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo -DWITH_ASAN=On ..
          make -j4
        shell: bash
      - name: CXX Tests
        run: |
          cd build
          ctest --verbose
        shell: bash

  build-tsan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Prepare Environment
        run: |
          sudo apt-get install libgtest-dev
          ./.github/workflows/install_gbench.sh
          sudo ./dependencies.sh
          #sudo apt-get install libprotobuf-dev
          #./.github/workflows/install_grpc.sh
        shell: bash
      - name: Build Reindexer
        run: |
          #export CPLUS_INCLUDE_PATH=$GITHUB_WORKSPACE/grpc/third_party/abseil-cpp
          mkdir build && cd build
          #cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo -DWITH_TSAN=On -DENABLE_GRPC=ON -DGRPC_PACKAGE_PROVIDER="MODULE" ..
          cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo -DWITH_TSAN=On ..
          make -j4
          STRIP=/bin/true cpack
        shell: bash
      - name: CXX Tests
        run: |
          cd build
          ctest --verbose
        shell: bash

# test-pyreindexer:
#   runs-on: ubuntu-latest
#   steps:
#     - uses: actions/checkout@v2
#     - name: Test PyReindexer
#       env:
#         PYRX_GH_TOKEN: ${{ secrets.PYRX_GH_TOKEN }}
#       run: .github/workflows/pyreindexer_workflow.sh
#       shell: bash

